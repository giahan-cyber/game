<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Vocabulary Card Battle ‚Äì Hero Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.2);
      --accent-strong: #a855f7;
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #fb7185;
      --success: #4ade80;
      --card: rgba(15, 23, 42, 0.96);
      --border-subtle: rgba(148, 163, 184, 0.25);
      --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.85);
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #0f172a 0, rgba(6, 78, 59, 0.7) 25%, #020617 55%, #000 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .game {
      width: 100%;
      max-width: 1120px;
      background: radial-gradient(circle at top left, rgba(22, 101, 52, 0.35), rgba(15,23,42,0.96));
      border-radius: 24px;
      padding: 18px 20px 22px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(34, 197, 94, 0.45);
      backdrop-filter: blur(18px);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-block h1 span {
      font-size: 1.6rem;
    }

    .title-pill {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--accent);
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background:
        radial-gradient(circle at top left, rgba(22,163,74,0.6), transparent);
    }

    .subtitle {
      margin: 3px 0 0;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--muted);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
    }

    .pill span {
      opacity: 0.8;
    }

    #restart-btn {
      border: none;
      padding: 6px 13px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, var(--accent), #4ade80);
      color: #022c22;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.65),
                  0 12px 30px rgba(22, 163, 74, 0.65);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      display: none;
    }

    #restart-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(22, 163, 74, 0.85);
    }

    main.board {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
      gap: 14px;
    }

    @media (max-width: 840px) {
      main.board {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.28), rgba(15,23,42,0.96));
      border-radius: var(--radius-xl);
      padding: 12px 12px 14px;
      border: 1px solid rgba(148, 163, 184, 0.28);
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tag {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
      background: rgba(15,23,42,0.85);
    }

    .status-top {
      display: grid;
      grid-template-columns: 1.02fr 0.98fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-shell {
      background: var(--card);
      border-radius: 18px;
      padding: 9px 10px 11px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 18px 40px rgba(0,0,0,0.85);
      position: relative;
      overflow: hidden;
    }

    .card-shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0.08;
      background: conic-gradient(
        from 180deg at 50% 50%,
        rgba(22, 163, 74, 1),
        rgba(34, 197, 94, 1),
        rgba(190, 242, 100, 1),
        rgba(22, 163, 74, 1)
      );
      filter: blur(24px);
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .char-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .enemy-name,
    .player-name {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
    }

    .enemy-name span:first-child,
    .player-name span:first-child {
      font-size: 0.86rem;
      font-weight: 600;
    }

    .label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .char-avatar {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.7rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
    }

    .char-avatar.hero {
      background: radial-gradient(circle at top, rgba(34, 197, 94, 0.6), rgba(15,23,42,1));
      border: 1px solid rgba(34, 197, 94, 0.8);
    }

    .char-avatar.enemy {
      background: radial-gradient(circle at top, rgba(239, 68, 68, 0.6), rgba(15,23,42,1));
      border: 1px solid rgba(248, 113, 113, 0.9);
    }

    .hp-bar {
      margin-top: 6px;
      width: 100%;
      height: 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      overflow: hidden;
    }

    .hp-bar-inner {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #a3e635, #facc15);
      width: 100%;
      transition: width 0.25s ease-out;
    }

    .hp-bar-inner.enemy {
      background: linear-gradient(90deg, #fb7185, #fb923c, #facc15);
    }

    .stats-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      color: var(--muted);
      flex-wrap: wrap;
      gap: 4px;
    }

    .stats-row strong {
      color: var(--text);
      font-weight: 600;
    }

    .tiny-tagline {
      margin-top: 5px;
      font-size: 0.74rem;
      color: var(--muted);
      opacity: 0.9;
    }

    .question-box {
      margin-top: 8px;
      padding: 8px 9px;
      border-radius: 14px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(148, 163, 184, 0.55);
      font-size: 0.85rem;
    }

    .question-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin-bottom: 6px;
    }

    #question-meaning {
      margin: 0 0 5px;
      font-size: 0.9rem;
    }

    #question-example {
      margin: 0;
      color: var(--muted);
      font-size: 0.78rem;
      font-style: italic;
    }

    .tiny-hint {
      margin-top: 4px;
      font-size: 0.74rem;
      color: var(--muted);
    }

    .hand {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .card {
      position: relative;
      padding: 10px 9px 11px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(21, 128, 61, 0.65), rgba(15,23,42,1));
      border: 1px solid rgba(74, 222, 128, 0.75);
      cursor: pointer;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.85);
      transform-origin: center bottom;
      transition:
        transform 0.16s ease,
        box-shadow 0.16s ease,
        border-color 0.16s ease,
        background 0.16s ease,
        filter 0.16s ease;
    }

    .card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 22px 50px rgba(34, 197, 94, 0.7);
      border-color: rgba(190, 242, 100, 0.9);
      background: radial-gradient(circle at top left, rgba(101,163,13,0.8), rgba(15,23,42,1));
      filter: saturate(1.2);
    }

    .card.disabled {
      opacity: 0.4;
      pointer-events: none;
      transform: translateY(0) scale(1);
      box-shadow: none;
      filter: grayscale(0.4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
      margin-bottom: 4px;
    }

    .card-word {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 0.95rem;
    }

    .card-rarity {
      font-size: 0.68rem;
      text-transform: uppercase;
      padding: 2px 7px;
      border-radius: 999px;
      letter-spacing: 0.12em;
      border: 1px solid rgba(190, 242, 100, 0.9);
      color: rgba(236, 253, 245, 0.95);
      background: radial-gradient(circle at top, rgba(74, 222, 128, 0.6), rgba(15, 23, 42, 1));
    }

    .rarity-common {
      border-color: rgba(148, 163, 184, 0.9);
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.45), rgba(15,23,42,1));
    }

    .rarity-rare {
      border-color: rgba(59, 130, 246, 0.95);
      background: radial-gradient(circle at top, rgba(59,130,246,0.6), rgba(15,23,42,1));
    }

    .rarity-epic {
      border-color: rgba(244, 114, 182, 0.95);
      background: radial-gradient(circle at top, rgba(236,72,153,0.75), rgba(15,23,42,1));
    }

    .card-body {
      font-size: 0.78rem;
      color: var(--muted);
      min-height: 30px;
    }

    .card-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.74rem;
      color: var(--muted);
    }

    .stars {
      font-size: 0.7rem;
      letter-spacing: 0.06em;
    }

    .stars span {
      filter: drop-shadow(0 0 4px rgba(250, 204, 21, 0.7));
    }

    .xp-bar {
      width: 54px;
      height: 5px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.75);
      overflow: hidden;
    }

    .xp-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.25s ease-out;
    }

    .topic-pill {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .topic-pill span {
      opacity: 0.9;
    }

    .feedback {
      margin-top: 9px;
      font-size: 0.82rem;
      min-height: 20px;
    }

    .feedback.good {
      color: var(--success);
    }

    .feedback.bad {
      color: var(--danger);
    }

    .feedback span.highlight {
      font-weight: 600;
      color: #e5e7eb;
    }

    footer {
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    footer span {
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <div class="game">
    <header>
      <div class="title-block">
        <div class="title-pill">Vocabulary Card Battle ¬∑ Hero Edition</div>
        <h1>
          ƒê·∫•u boss b·∫±ng t·ª´ v·ª±ng
          <span>üßô‚Äç‚ôÄÔ∏è‚öîÔ∏èüëæ</span>
        </h1>
        <p class="subtitle">
          M·ªói l·∫ßn ch·ªçn ƒë√∫ng <strong>t·ª´ ti·∫øng Anh</strong>, anh h√πng c·ªßa b·∫°n tung chi√™u g√¢y s√°t th∆∞∆°ng l√™n qu√°i v·∫≠t.
          L√° b√†i c√†ng ƒë∆∞·ª£c d√πng ƒë√∫ng nhi·ªÅu ‚Üí c√†ng l√™n level & nhi·ªÅu sao ‚≠ê.
        </p>
      </div>
      <div class="controls">
        <div class="pill">
          ‚è± <span>V√≤ng ch∆°i nhanh ~1‚Äì3 ph√∫t</span>
        </div>
        <div class="pill">
          üéÆ <span>Click v√†o l√° b√†i ƒë·ªÉ t·∫•n c√¥ng</span>
        </div>
        <button id="restart-btn">Ch∆°i l·∫°i</button>
      </div>
    </header>

    <main class="board">
      <!-- LEFT: Status + Question -->
      <section class="panel">
        <h2>
          Chi·∫øn tr∆∞·ªùng t·ª´ v·ª±ng
          <span class="tag" id="round-label">M√†n 1</span>
        </h2>

        <div class="status-top">
          <!-- Hero -->
          <div class="card-shell">
            <div class="card-inner">
              <div class="char-row">
                <div>
                  <div class="player-name">
                    <span id="player-name">Ng∆∞·ªùi h·ªçc t·ª´</span>
                    <span class="label">Anh h√πng</span>
                  </div>
                  <div class="tiny-tagline" id="player-tagline">S·ª≠ d·ª•ng t·ª´ v·ª±ng ƒë·ªÉ tung ph√©p thu·∫≠t.</div>
                </div>
                <div class="char-avatar hero" id="player-sprite">üßô‚Äç‚ôÄÔ∏è</div>
              </div>
              <div class="hp-bar">
                <div class="hp-bar-inner" id="player-hp-bar"></div>
              </div>
              <div class="stats-row">
                <div><span class="label">HP:</span> <strong id="player-hp-text">20 / 20</strong></div>
                <div>
                  <span class="label">ƒêi·ªÉm:</span> <strong id="score-text">0</strong>
                  &nbsp;&nbsp; <span class="label">Chu·ªói ƒë√∫ng:</span> <strong id="streak-text">0</strong>
                </div>
              </div>
            </div>
          </div>

          <!-- Enemy -->
          <div class="card-shell">
            <div class="card-inner">
              <div class="char-row">
                <div>
                  <div class="enemy-name">
                    <span id="enemy-name">Goblin Ng·ªØ Ph√°p</span>
                    <span class="label">Qu√°i v·∫≠t</span>
                  </div>
                  <div class="tiny-tagline" id="enemy-tagline">Say m√™ b·∫Øt l·ªói t·ª´ v·ª±ng c·ªßa b·∫°n.</div>
                </div>
                <div class="char-avatar enemy" id="enemy-sprite">üëπ</div>
              </div>
              <div class="hp-bar">
                <div class="hp-bar-inner enemy" id="enemy-hp-bar"></div>
              </div>
              <div class="stats-row">
                <div><span class="label">HP:</span> <strong id="enemy-hp-text">10 / 10</strong></div>
                <div><span class="label">Lv.</span> <strong id="enemy-level">1</strong></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Question -->
        <div class="question-box">
          <div class="question-title">Nhi·ªám v·ª• c·ªßa b·∫°n</div>
          <p id="question-meaning">Nh·∫•n "Ch∆°i l·∫°i" n·∫øu game ch∆∞a b·∫Øt ƒë·∫ßu.</p>
          <p id="question-example"></p>
          <p class="tiny-hint">
            G·ª£i √Ω: ƒë·ªçc k·ªπ <strong>nghƒ©a ti·∫øng Vi·ªát</strong> & c√¢u v√≠ d·ª• r·ªìi ch·ªçn
            <strong>t·ª´ ti·∫øng Anh</strong> ph√π h·ª£p nh·∫•t ·ªü b√™n ph·∫£i. C√¢u ƒë√∫ng = 1 ƒë√≤n t·∫•n c√¥ng.
          </p>
        </div>
      </section>

      <!-- RIGHT: Hand -->
      <section class="panel">
        <h2>
          B·ªô b√†i ph√©p thu·∫≠t
          <span class="tag">ƒêang r√∫t ng·∫´u nhi√™n 4 l√° / l∆∞·ª£t</span>
        </h2>
        <div id="hand" class="hand">
          <!-- Cards render here -->
        </div>
        <div id="feedback" class="feedback"></div>
      </section>
    </main>

    <footer>
      <span>üí° Em c√≥ th·ªÉ s·ª≠a danh s√°ch t·ª´ trong bi·∫øn <code>vocabulary</code> b√™n d∆∞·ªõi cho ƒë√∫ng ch·ªß ƒë·ªÅ mu·ªën h·ªçc.</span>
      <span>Prototype by em & anh ChatGPT ‚Äì h·ªçc t·ª´ nh∆∞ ch∆°i RPG, kh√¥ng bu·ªìn ng·ªß.</span>
    </footer>
  </div>

  <script>
    // ================== DATA ==================
    // Danh s√°ch t·ª´ ‚Äì em ch·ªânh tu·ª≥ √Ω
    const vocabulary = [
      {
        id: 1,
        word: "negotiate",
        meaning: "ƒë√†m ph√°n, th∆∞∆°ng l∆∞·ª£ng",
        example: "We need to negotiate a better price with the supplier.",
        rarity: "rare",
        topic: "business"
      },
      {
        id: 2,
        word: "deadline",
        meaning: "h·∫°n ch√≥t, th·ªùi h·∫°n",
        example: "The deadline for this project is next Monday.",
        rarity: "common",
        topic: "business"
      },
      {
        id: 3,
        word: "efficient",
        meaning: "hi·ªáu qu·∫£ (s·ª≠ d·ª•ng √≠t th·ªùi gian/c√¥ng s·ª©c)",
        example: "This new method is much more efficient than the old one.",
        rarity: "common",
        topic: "work"
      },
      {
        id: 4,
        word: "reliable",
        meaning: "ƒë√°ng tin c·∫≠y",
        example: "She is a reliable colleague who always finishes her tasks.",
        rarity: "common",
        topic: "personality"
      },
      {
        id: 5,
        word: "persuade",
        meaning: "thuy·∫øt ph·ª•c",
        example: "He managed to persuade his boss to accept the idea.",
        rarity: "rare",
        topic: "communication"
      },
      {
        id: 6,
        word: "exhausted",
        meaning: "ki·ªát s·ª©c, m·ªát l·ª≠",
        example: "I felt exhausted after working all night.",
        rarity: "common",
        topic: "feelings"
      },
      {
        id: 7,
        word: "curious",
        meaning: "t√≤ m√≤, hi·∫øu k·ª≥",
        example: "The child was very curious about how the machine worked.",
        rarity: "common",
        topic: "personality"
      },
      {
        id: 8,
        word: "conference",
        meaning: "h·ªôi ngh·ªã, cu·ªôc h·ªçp l·ªõn",
        example: "She is attending an international conference this week.",
        rarity: "rare",
        topic: "business"
      },
      {
        id: 9,
        word: "priority",
        meaning: "∆∞u ti√™n, vi·ªác quan tr·ªçng tr∆∞·ªõc",
        example: "Safety is our top priority.",
        rarity: "rare",
        topic: "work"
      },
      {
        id: 10,
        word: "reschedule",
        meaning: "d·ªùi l·ªãch, s·∫Øp x·∫øp l·∫°i th·ªùi gian",
        example: "Can we reschedule the meeting to tomorrow afternoon?",
        rarity: "epic",
        topic: "business"
      }
    ];

    // Hero & qu√°i cho c√≥ "nh√¢n v·∫≠t"
    const heroes = [
      {
        name: "Ph√°p S∆∞ T·ª´ V·ª±ng",
        sprite: "üßô‚Äç‚ôÄÔ∏è",
        tagline: "Bi·∫øn t·ª´ v·ª±ng th√†nh ph√©p thu·∫≠t."
      },
      {
        name: "Hi·ªáp Sƒ© Ng·ªØ Ph√°p",
        sprite: "üõ°Ô∏è",
        tagline: "B·∫£o v·ªá c√¢u c√∫ kh·ªèi l·ªói sai."
      },
      {
        name: "Trinh Th√°m T·ª´ ƒêi·ªÉn",
        sprite: "üïµÔ∏è‚Äç‚ôÇÔ∏è",
        tagline: "L·∫ßn theo manh m·ªëi t·ª´ v·ª±ng."
      },
      {
        name: "H·ªçc Gi·∫£ Ghi Ch√∫",
        sprite: "üßë‚Äçüéì",
        tagline: "Kh√¥ng b·ªè s√≥t m·ªôt t·ª´ n√†o."
      }
    ];

    const enemyTypes = [
      {
        label: "Slime Ch√≠nh T·∫£",
        sprite: "üü¢",
        tagline: "Chuy√™n l√†m b·∫°n nh·∫ßm l·∫´n spelling."
      },
      {
        label: "Goblin Ng·ªØ Ph√°p",
        sprite: "üëπ",
        tagline: "R√¨nh r·∫≠p b·∫Øt l·ªói c·∫•u tr√∫c c√¢u."
      },
      {
        label: "Ph√π Th·ªßy Vi·∫øt L√°ch",
        sprite: "üßå",
        tagline: "Th√≠ch d√πng t·ª´ kh√≥ ƒë·ªÉ g√¢y r·ªëi."
      },
      {
        label: "R·ªìng T·ª´ V·ª±ng Non",
        sprite: "üêâ",
        tagline: "ƒê·ªô kh√≥ tƒÉng m·∫°nh, ƒë√≤i h·ªèi v·ªën t·ª´ cao."
      }
    ];

    // M·ªói card s·∫Ω c√≥ th√™m d·ªØ li·ªáu gameplay
    let deck = [];

    const player = {
      maxHp: 20,
      hp: 20,
      score: 0,
      streak: 0,
      name: "Ng∆∞·ªùi h·ªçc t·ª´",
      sprite: "üßô‚Äç‚ôÄÔ∏è",
      tagline: "S·ª≠ d·ª•ng t·ª´ v·ª±ng ƒë·ªÉ tung ph√©p thu·∫≠t."
    };

    const enemy = {
      name: "Goblin Ng·ªØ Ph√°p",
      level: 1,
      maxHp: 10,
      hp: 10,
      baseHp: 10,
      sprite: "üëπ",
      tagline: "Say m√™ b·∫Øt l·ªói t·ª´ v·ª±ng c·ªßa b·∫°n."
    };

    let round = 1;
    const HAND_SIZE = 4;
    let hand = [];
    let currentQuestionCard = null;
    let gameOver = false;

    // ================== UTILS ==================
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function getRarityLabel(r) {
      switch (r) {
        case "common": return "Common";
        case "rare": return "Rare";
        case "epic": return "Epic";
        default: return "Common";
      }
    }

    function getRarityClass(r) {
      switch (r) {
        case "common": return "rarity-common";
        case "rare": return "rarity-rare";
        case "epic": return "rarity-epic";
        default: return "rarity-common";
      }
    }

    function calcDamage(card) {
      // S√°t th∆∞∆°ng d·ª±a tr√™n level + level qu√°i
      return 2 + card.level + Math.floor(enemy.level / 2);
    }

    function calcEnemyHp(level) {
      return enemy.baseHp + (level - 1) * 4;
    }

    function clamp(num, min, max) {
      return Math.min(Math.max(num, min), max);
    }

    // ================== GAME LOGIC ==================
    function initDeck() {
      deck = vocabulary.map((v) => ({
        ...v,
        level: 1,
        xp: 0,
        mastery: 0, // 0‚Äì3 sao
        correctStreak: 0,
        seen: 0,
        wrong: 0
      }));
    }

    function pickRandomHero() {
      const hero = heroes[Math.floor(Math.random() * heroes.length)];
      player.name = hero.name;
      player.sprite = hero.sprite;
      player.tagline = hero.tagline;
    }

    function pickEnemyForCurrentRound() {
      // ƒê·ªïi lo·∫°i qu√°i theo round, l·∫∑p v√≤ng quanh m·∫£ng enemyTypes
      const idx = (round - 1) % enemyTypes.length;
      const type = enemyTypes[idx];
      enemy.name = type.label;
      enemy.sprite = type.sprite;
      enemy.tagline = type.tagline;
      enemy.maxHp = calcEnemyHp(enemy.level);
      enemy.hp = enemy.maxHp;
    }

    function startGame() {
      player.hp = player.maxHp;
      player.score = 0;
      player.streak = 0;

      round = 1;
      enemy.level = 1;
      enemy.baseHp = 10;

      pickRandomHero();
      initDeck();
      pickEnemyForCurrentRound();

      gameOver = false;
      drawNewHandAndQuestion();
      updateAllUI();
      setFeedback("Ch·ªçn l√° b√†i ƒë√∫ng v·ªõi nghƒ©a b√™n tr√°i ƒë·ªÉ anh h√πng c·ªßa b·∫°n tung chi√™u ƒë·∫ßu ti√™n! ‚öîÔ∏è", "");
      toggleRestart(false);
    }

    function toggleRestart(show) {
      const btn = document.getElementById("restart-btn");
      btn.style.display = show ? "inline-flex" : "none";
    }

    function drawNewHandAndQuestion() {
      if (gameOver) return;

      // ∆Øu ti√™n nh·ªØng l√° √≠t ƒë∆∞·ª£c xem ho·∫∑c sai nhi·ªÅu (nh∆∞ SRS mini)
      const sorted = deck.slice().sort((a, b) => {
        const scoreA = a.seen + a.wrong * 2;
        const scoreB = b.seen + b.wrong * 2;
        return scoreA - scoreB;
      });
      const base = sorted.slice(0, Math.min(6, sorted.length));
      hand = shuffleArray(base).slice(0, HAND_SIZE);

      // Ch·ªçn 1 l√° trong hand l√†m ƒë√°p √°n
      currentQuestionCard = hand[Math.floor(Math.random() * hand.length)];
      currentQuestionCard.seen += 1;

      updateQuestionUI();
      renderHand();
    }

    function handleCardClick(cardId) {
      if (gameOver) return;
      const selected = hand.find((c) => c.id === cardId);
      if (!selected || !currentQuestionCard) return;

      const isCorrect = selected.id === currentQuestionCard.id;

      if (isCorrect) {
        // ƒê√∫ng
        player.streak += 1;
        player.score += 10 + 3 * enemy.level + 2 * currentQuestionCard.level;
        selected.correctStreak += 1;

        // Level + XP
        selected.xp += 1;
        if (selected.xp >= 3 && selected.level < 5) {
          selected.xp = 0;
          selected.level += 1;
          if (selected.mastery < 3) {
            selected.mastery += 1;
          }
        }

        const damage = calcDamage(selected);
        enemy.hp = clamp(enemy.hp - damage, 0, enemy.maxHp);

        setFeedback(
          `Chu·∫©n! <span class="highlight">${player.name}</span> d√πng l√° b√†i <span class="highlight">${selected.word}</span> g√¢y <span class="highlight">${damage} s√°t th∆∞∆°ng</span>!`,
          "good"
        );

        if (enemy.hp <= 0) {
          // Qua m√†n, qu√°i m·ªõi
          round += 1;
          enemy.level += 1;
          pickEnemyForCurrentRound();
          setFeedback(
            `üî• B·∫°n ƒë√£ h·∫° g·ª•c <span class="highlight">qu√°i v·∫≠t</span>! M√†n ${round} b·∫Øt ƒë·∫ßu ‚Äì qu√°i m·∫°nh h∆°n nh∆∞ng anh h√πng c·ªßa b·∫°n c≈©ng ƒë√£ d√†y d·∫°n kinh nghi·ªám h∆°n.`,
            "good"
          );
        }
      } else {
        // Sai
        player.streak = 0;
        const damageTaken = 3 + enemy.level;
        player.hp = clamp(player.hp - damageTaken, 0, player.maxHp);
        selected.wrong += 1;
        currentQuestionCard.wrong += 1;

        setFeedback(
          `Sai m·∫•t r·ªìi üò¢ <span class="highlight">${enemy.name}</span> ph·∫£n ƒë√≤n, b·∫°n m·∫•t <span class="highlight">${damageTaken} HP</span>.<br/>
          ƒê√°p √°n ƒë√∫ng: <span class="highlight">${currentQuestionCard.word}</span> ‚Äì ${currentQuestionCard.meaning}.`,
          "bad"
        );

        if (player.hp <= 0) {
          handleGameOver();
          return;
        }
      }

      updateAllUI();

      // Kho√° hand t·∫°m ƒë·ªÉ tr√°nh spam
      disableHandTemp();
      setTimeout(() => {
        drawNewHandAndQuestion();
        updateAllUI();
      }, 500);
    }

    function handleGameOver() {
      gameOver = true;
      setFeedback(
        `Game over üíÄ <span class="highlight">${player.name}</span> g·ª•c ng√£ ·ªü m√†n <span class="highlight">${round}</span>. 
        T·ªïng ƒëi·ªÉm: <span class="highlight">${player.score}</span>. Nh·∫•n "Ch∆°i l·∫°i" ƒë·ªÉ th·ª≠ build m·ªõi & luy·ªán l·∫°i b·ªô b√†i c·ªßa b·∫°n.`,
        "bad"
      );
      toggleRestart(true);
      disableHand(true);
    }

    // ================== UI ==================
    function updateAllUI() {
      updateStatusUI();
      updateQuestionUI();
      renderHand();
    }

    function updateStatusUI() {
      // Hero
      document.getElementById("player-name").textContent = player.name;
      document.getElementById("player-sprite").textContent = player.sprite;
      document.getElementById("player-tagline").textContent = player.tagline;

      document.getElementById("player-hp-text").textContent = `${player.hp} / ${player.maxHp}`;
      const playerHpBar = document.getElementById("player-hp-bar");
      const playerHpPercent = (player.hp / player.maxHp) * 100;
      playerHpBar.style.width = `${playerHpPercent}%`;

      document.getElementById("score-text").textContent = player.score;
      document.getElementById("streak-text").textContent = player.streak;

      // Enemy
      document.getElementById("enemy-name").textContent = enemy.name;
      document.getElementById("enemy-sprite").textContent = enemy.sprite;
      document.getElementById("enemy-tagline").textContent = enemy.tagline;
      document.getElementById("enemy-level").textContent = enemy.level;
      document.getElementById("round-label").textContent = `M√†n ${round}`;

      document.getElementById("enemy-hp-text").textContent = `${enemy.hp} / ${enemy.maxHp}`;
      const enemyHpBar = document.getElementById("enemy-hp-bar");
      const enemyHpPercent = (enemy.hp / enemy.maxHp) * 100;
      enemyHpBar.style.width = `${enemyHpPercent}%`;
    }

    function updateQuestionUI() {
      const meaningEl = document.getElementById("question-meaning");
      const exampleEl = document.getElementById("question-example");

      if (!currentQuestionCard) {
        meaningEl.textContent = 'Nh·∫•n "Ch∆°i l·∫°i" ƒë·ªÉ b·∫Øt ƒë·∫ßu v√°n m·ªõi.';
        exampleEl.textContent = "";
        return;
      }

      meaningEl.textContent = currentQuestionCard.meaning;
      exampleEl.textContent = "V√≠ d·ª•: " + currentQuestionCard.example;
    }

    function renderHand() {
      const handContainer = document.getElementById("hand");
      handContainer.innerHTML = "";

      hand.forEach((card) => {
        const cardEl = document.createElement("article");
        cardEl.className = "card";
        cardEl.dataset.cardId = card.id;

        const rarityClass = getRarityClass(card.rarity);
        const rarityLabel = getRarityLabel(card.rarity);

        const stars = "‚òÖ".repeat(card.mastery) + "‚òÜ".repeat(3 - card.mastery);
        const xpPercent = (card.xp / 3) * 100;

        cardEl.innerHTML = `
          <div class="card-header">
            <div class="card-word">${card.word}</div>
            <div class="card-rarity ${rarityClass}">${rarityLabel}</div>
          </div>
          <div class="card-body">
            Level: <strong>${card.level}</strong><br/>
            ƒê√£ g·∫∑p: ${card.seen} l·∫ßn
            <div class="topic-pill">
              üìö <span>${card.topic}</span>
            </div>
          </div>
          <div class="card-footer">
            <div class="stars">${stars.split("").map((s) => `<span>${s}</span>`).join("")}</div>
            <div class="xp-bar">
              <div class="xp-fill" style="width:${xpPercent}%;"></div>
            </div>
          </div>
        `;

        cardEl.addEventListener("click", () => handleCardClick(card.id));
        handContainer.appendChild(cardEl);
      });
    }

    function setFeedback(message, type) {
      const feedbackEl = document.getElementById("feedback");
      feedbackEl.className = "feedback";
      if (type === "good") feedbackEl.classList.add("good");
      if (type === "bad") feedbackEl.classList.add("bad");
      feedbackEl.innerHTML = message;
    }

    function disableHandTemp() {
      disableHand(true);
      setTimeout(() => disableHand(false), 450);
    }

    function disableHand(disabled) {
      const handContainer = document.getElementById("hand");
      const cards = handContainer.querySelectorAll(".card");
      cards.forEach((cardEl) => {
        if (disabled) {
          cardEl.classList.add("disabled");
        } else {
          cardEl.classList.remove("disabled");
        }
      });
    }

    // ================== INIT ==================
    document.addEventListener("DOMContentLoaded", () => {
      const restartBtn = document.getElementById("restart-btn");
      restartBtn.addEventListener("click", startGame);

      // Kh·ªüi ƒë·ªông game l·∫ßn ƒë·∫ßu
      startGame();
    });
  </script>
</body>
</html>
